# AngelHeart - 更懂分寸的智能群聊伙伴

AngelHeart 是一个为 AstrBot 平台设计的智能群聊交互插件。它采用**轻量级架构**，旨在成为一个专注、懂分寸、有眼色的聊天伙伴，而不是一个打扰人的话痨。

## ✨ 核心设计

插件的核心是**成本与效果的平衡**，通过两级AI协作和智能计时器，实现高质量、低成本的群聊交互。

`上游对话历史 + 计时器触发 → 轻量级AI分析 → (若需要) 重量级AI生成回复`

1.  **两级AI协作 (前台/专家模式)**
    *   **轻量级AI (分析员)**: 使用快速、低成本模型，分析对话上下文，判断“是否值得回复”。它处理了绝大多数的静默观察情况。
    *   **重量级AI (专家)**: 仅在“分析员”认为有必要时激活，使用强大、高成本模型，生成真正有深度和高质量的回复。

2.  **计时器调度器 (`TimerDispatcher`)**
    *   当群聊中出现新消息时，插件会启动一个（默认为7秒）的计时器，静静观察。
    *   这给了群内成员优先回复的机会，避免AI抢话。
    *   如果在等待期间有新消息，计时器会重置。
    *   只有当对话自然冷却，计时器走完，AI才会开始分析是否需要介入。

## 🚀 如何使用

1.  将插件放入 AstrBot 的 `data/plugins` 目录。
2.  在 AstrBot 的 WebUI 中启用 `AngelHeart` 插件。
3.  **关键配置**：
    *   `轻量级分析模型`: 设置一个用于分析的模型提供商名称 (例如，速度快、成本低的模型)。
    *   `重量级生成模型`: 设置一个用于生成回复的模型提供商名称 (例如，能力强的主力模型)。
    *   `等待时间`: 自定义AI在分析前需要等待的时间。
    *   `白名单`: 可以设置只在特定的群聊中启用。
4.  确保你在 AstrBot 中已经配置了上述两个模型提供商。

## 🎮 管理员命令

*   `/angelheart`: 查看插件的运行状态，包括活跃定时器数量和处理统计。
*   `/angelheart_reset`: 在当前群聊中，手动重置并取消正在等待的计时器。
*   `/angelheart_health`: 显示插件的健康检查信息，包括缓存状态和性能指标。
*   `/angelheart_reload`: 重新加载插件配置。

## 📋 依赖

本插件依赖 `apscheduler` 来实现计时器功能。请确保已在您的环境中安装：

```bash
pip install apscheduler
```

## 📁 项目结构

重构后的项目结构非常简洁，核心逻辑清晰地分布在几个文件中：

```
astrbot_plugin_angel_heart/
├── main.py                    # 插件主入口，负责消息过滤和启动计时器
├── metadata.yaml              # 插件元数据
├── _conf_schema.json          # WebUI配置文件定义
├── README.md                  # 就是本文件
├── core/
│   └── llm_analyzer.py        # LLM分析器，实现两级AI协作
├── models/
│   └── analysis_result.py     # 用于封装AI分析结果的数据模型
└── rules/
    └── timer_dispatcher.py    # 计时器调度器
```

## 📄 许可证

本项目采用 MIT 许可证。